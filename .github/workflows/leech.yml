name: Syzo Leech Worker
on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          # Menggunakan nama secret yang konsisten
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ö° *Worker Started!*%0A sedang men-download dari SourceForge...&parse_mode=Markdown"

      - name: Download File from SourceForge
        run: |
          sudo apt-get install -y aria2
          # Menggunakan wget dengan disguise browser agar tidak 403
          wget -U "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
               --header="Referer: https://sourceforge.net/" \
               -O leech_file \
               "${{ github.event.client_payload.url }}"

      - name: Upload to GoFile
        run: |
          echo "üöÄ Memulai upload anonim ke GoFile..."
          # Menggunakan endpoint global terbaru
          RESPONSE=$(curl -F "file=@leech_file" https://upload.gofile.io/uploadfile)
          
          echo "Respon Server: $RESPONSE"
          
          # Mengambil link download dari respon JSON
          DOWNLOAD_URL=$(echo $RESPONSE | jq -r '.data.downloadPage')
          
          if [ "$DOWNLOAD_URL" != "null" ] && [ -z "$DOWNLOAD_URL" != false ]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
            echo "‚úÖ Berhasil! Link: $DOWNLOAD_URL"
          else
            echo "‚ùå Gagal mendapatkan link. Respon server: $RESPONSE"
            exit 1
          fi

      - name: Notify Telegram (Success)
        if: success()
        run: |
          # Ambil link download dari environment yang disimpan di step sebelumnya
          LINK="${{ env.DOWNLOAD_URL }}"
          
          # Kirim ke Telegram menggunakan nama secret yang sudah disatukan
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>‚úÖ Leech Berhasil!</b>%0A%0Aüîó <b>Link Download:</b> $LINK"
