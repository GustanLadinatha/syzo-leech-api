name: Syzo-Leech-Worker

on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 jq
          echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV

      - name: Universal High-Speed Download
        run: |
          URL="${{ github.event.client_payload.url }}"
          echo "üöÄ Downloading from: $URL"
          # Mesin download utama
          aria2c -x 16 -s 16 -k 1M --console-log-level=notice --summary-interval=0 "$URL" -d .
          
          # Mendeteksi file hasil download
          FILE_PATH=$(ls -t | grep -v "index.py" | grep -v "vercel.json" | grep -v "yml" | head -n 1)
          echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV
          echo "FILENAME=$(basename "$FILE_PATH")" >> $GITHUB_ENV

      - name: Upload to Multi-Cloud (GoFile)
        id: upload_step
        continue-on-error: true 
        run: |
          echo "üöÄ Getting Best GoFile Server..."
          SERVER=$(curl -s https://api.gofile.io/servers | jq -r '.data.servers[0].name // "store1"')
          
          echo "üöÄ Uploading to GoFile ($SERVER)..."
          RESPONSE=$(curl -s -F "file=@${{ env.FILE_PATH }}" "https://${SERVER}.gofile.io/contents/uploadfile")
          
          STATUS=$(echo $RESPONSE | jq -r '.status')
          if [[ "$STATUS" == "ok" ]]; then
            DOWNLOAD_URL=$(echo $RESPONSE | jq -r '.data.downloadPage')
            echo "FINAL_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          else
            echo "‚ùå Upload Failed, using Fallback"
            echo "FINAL_URL=${{ github.event.client_payload.url }}" >> $GITHUB_ENV
          fi

      - name: Generate MD5 & Notify Vercel
        if: always()
        run: |
          # --- PROSES GENERATE MD5 ---
          FILE_MD5=$(md5sum "${{ env.FILE_PATH }}" | awk '{print $1}')
          echo "FILE_MD5=$FILE_MD5" >> $GITHUB_ENV
          
          URL_TO_SEND="${{ env.FINAL_URL }}"
          if [[ -z "$URL_TO_SEND" ]]; then URL_TO_SEND="${{ github.event.client_payload.url }}"; fi
          
          echo "üì° Sending data to Vercel with MD5..."
          curl -s -X POST "https://syzo-leech-api.vercel.app/update_link" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"${{ github.run_id }}\", \"download_url\": \"$URL_TO_SEND\", \"filename\": \"${{ env.FILENAME }}\", \"md5\": \"$FILE_MD5\"}"

      - name: Notify Telegram Success
        if: success() # Hanya jalan jika semua proses (download & upload) BERHASIL
        run: |
          MESSAGE="‚úÖ *Leech Completed*%0AüìÇ *File:* \`${{ env.FILENAME }}\` %0Aüîë *MD5:* \`${{ env.FILE_MD5 }}\` %0Aüîó [Download Link](${{ env.FINAL_URL }})"
          curl -s -X POST "https://api.telegram.org/bot8229203638:AAHI-0fu5NGv8kQmUm5ztd81gbOautvJBB4/sendMessage" \
          -d "chat_id=-5089072043&text=$MESSAGE&parse_mode=Markdown"

      - name: Notify Telegram Stopped/Failed
        if: cancelled() || failure() # Jalan jika user tekan STOP atau ada error
        run: |
          MESSAGE="üõë *Leech Stopped / Failed*%0A‚ö†Ô∏è Proses dihentikan oleh pengguna atau sistem.%0AüÜî Run ID: \`${{ github.run_id }}\`"
          curl -s -X POST "https://api.telegram.org/bot8229203638:AAHI-0fu5NGv8kQmUm5ztd81gbOautvJBB4/sendMessage" \
          -d "chat_id=-5089072043&text=$MESSAGE&parse_mode=Markdown"
