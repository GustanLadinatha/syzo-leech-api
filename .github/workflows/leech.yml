name: Syzo Leech Worker
on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ö° *Worker Started!*%0A sedang men-download dari SourceForge...&parse_mode=Markdown"

      - name: Download File from SourceForge
        run: |
          sudo apt-get install -y aria2
          URL="${{ github.event.client_payload.url }}"
          
          # Download dengan wget
          wget -U "Mozilla/5.0" --header="Referer: https://sourceforge.net/" --content-disposition "$URL"
          
          # Ambil nama file asli yang barusan didownload
          RAW_FILENAME=$(ls -p | grep -v / | head -n 1)
          
          # Bersihkan nama file dari karakter sesudah tanda '!' atau '?' (viasf, dll)
          CLEAN_FILENAME=$(echo "$RAW_FILENAME" | cut -d'!' -f1 | cut -d'?' -f1)
          
          # Ganti nama file di sistem agar saat upload namanya bersih
          if [ "$RAW_FILENAME" != "$CLEAN_FILENAME" ]; then
            mv "$RAW_FILENAME" "$CLEAN_FILENAME"
          fi
          
          echo "FILENAME=$CLEAN_FILENAME" >> $GITHUB_ENV
          echo "‚úÖ Berhasil download & bersihkan: $CLEAN_FILENAME"

      - name: Upload to GoFile
        run: |
          echo "üöÄ Memulai upload file: ${{ env.FILENAME }}"
          
          # Melakukan upload dan menyimpan respons ke file
          RESPONSE=$(curl -s -F "file=@${{ env.FILENAME }}" https://store-na-phx-3.gofile.io/contents/uploadfile)
          
          # Mengambil link download menggunakan 'jq' (lebih aman daripada grep/cut)
          DOWNLOAD_LINK=$(echo $RESPONSE | jq -r '.data.downloadPage')
          
          if [ "$DOWNLOAD_LINK" != "null" ]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_LINK" >> $GITHUB_ENV
            echo "‚úÖ Berhasil mendapatkan link: $DOWNLOAD_LINK"
          else
            echo "‚ùå Gagal mendapatkan link. Respon server: $RESPONSE"
            exit 1
          fi

      - name: Notify Telegram
  if: always() # Tambahkan ini agar tetap mengirim pesan walau step sebelumnya error
  run: |
    curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
    -d "chat_id=${{ secrets.CHAT_ID }}&text=‚úÖ Leech Berhasil!%0A%0AFile: ${{ env.FILENAME }}%0ALink: ${{ env.DOWNLOAD_URL }}"
