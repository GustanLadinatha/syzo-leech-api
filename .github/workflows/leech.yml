name: Syzo Leech Worker
on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ö° *Worker Started!*%0A Menyiapkan lingkungan bersih & analisa jalur...&parse_mode=Markdown"

      # --- LOGIKA SAFE START: JEDA & CEK CANCEL INSTAN ---
      - name: Safe Start Delay & Check
        run: |
          echo "Warming up and checking for early cancellation..."
          sleep 3
          
          STATUS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }} \
            | jq -r '.status')
          
          if [ "$STATUS" == "cancelled" ] || [ "$STATUS" == "cancelling" ]; then
            echo "üõë Cancellation detected early! Stopping worker immediately."
            exit 1
          fi

      - name: Universal High-Speed Download
        run: |
          sudo apt-get install -y aria2
          URL="${{ github.event.client_payload.url }}"
          rm -rf * 2>/dev/null
          FINAL_URL=$(curl -sL -o /dev/null -w %{url_effective} "$URL")
          
          aria2c -x1 -s1 -k1M --allow-overwrite=true --file-allocation=none \
          --user-agent="Mozilla/5.0" --header="Referer: https://sourceforge.net/" \
          --connect-timeout=60 --timeout=60 --max-tries=50 \
          --console-log-level=error --summary-interval=10 "$FINAL_URL"
          
          FILENAME=$(ls -p | grep -v / | head -n 1)
          CLEAN_NAME=$(echo "$FILENAME" | cut -d'!' -f1 | cut -d'?' -f1)
          [ "$FILENAME" != "$CLEAN_NAME" ] && mv "$FILENAME" "$CLEAN_NAME"
          
          echo "FILENAME=$CLEAN_NAME" >> $GITHUB_ENV
          echo "MD5_HASH=$(md5sum "$CLEAN_NAME" | awk '{print $1}')" >> $GITHUB_ENV

      - name: Upload to Multi-Cloud
        run: |
          echo "üöÄ Getting Best GoFile Server..."
          # Ambil server terbaik secara dinamis
          SERVER=$(curl -s https://api.gofile.io/servers | jq -r '.data.servers[0].name')
          echo "Using Server: $SERVER"

          echo "üöÄ Uploading to GoFile..."
          # Gunakan server dinamis hasil crawl tadi
          RESPONSE=$(curl -s -F "file=@${{ env.FILE_PATH }}" "https://${SERVER}.gofile.io/contents/uploadfile")
          
          # Cek apakah upload sukses
          STATUS=$(echo $RESPONSE | jq -r '.status')
          
          if [[ "$STATUS" == "ok" ]]; then
            DOWNLOAD_URL=$(echo $RESPONSE | jq -r '.data.downloadPage')
            echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
            echo "‚úÖ Upload Success: $DOWNLOAD_URL"
          else
            echo "‚ùå Upload Failed! Response: $RESPONSE"
            exit 1
          fi
      # --- TAMBAHAN: KIRIM LINK BALIK KE WEBSITE VIA VERCEL ---
      - name: Notify Vercel Result
        if: success()
        run: |
          curl -s -X POST "https://syzo-leech-api.vercel.app/update_link" \
          -H "Content-Type: application/json" \
          -d '{
            "run_id": "${{ github.run_id }}",
            "download_url": "${{ env.DOWNLOAD_URL_GOFILE }}",
            "filename": "${{ env.FILENAME }}",
            "md5": "${{ env.MD5_HASH }}"
          }'

      - name: Notify Telegram Success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>‚úÖ Leech Berhasil!</b>%0A%0AüìÑ <b>File:</b> ${{ env.FILENAME }}%0Aüîë <b>MD5:</b> <code>${{ env.MD5_HASH }}</code>%0A%0AüöÄ <b>GoFile:</b> ${{ env.DOWNLOAD_URL_GOFILE }}%0Aüì¶ <b>Catbox:</b> ${{ env.DOWNLOAD_URL_CATBOX }}%0A%0Aüßπ <i>Status: Disk dibersihkan.</i>"

      - name: Deep Cleanup
        if: always()
        run: |
          echo "üßπ Melakukan Deep Cleanup..."
          rm -rf * 2>/dev/null
