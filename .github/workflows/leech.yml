name: Syzo Leech Worker
on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=âš¡ *Worker Started!*%0A sedang men-download dari SourceForge...&parse_mode=Markdown"

      - name: Download File (Direct Mirror Mode)
        run: |
          sudo apt-get install -y aria2
          URL="${{ github.event.client_payload.url }}"
          
          # TRICK: Menghapus 'master.dl' dan menggantinya dengan 'downloads' 
          # Ini adalah cara resmi agar SourceForge mencarikan mirror yang mendukung multi-koneksi secara otomatis
          FINAL_URL=$(echo "$URL" | sed 's/master.dl/downloads/g')
          
          echo "ğŸš€ Menggunakan Jalur Direct: $FINAL_URL"
          
          # Kita pakai 10 koneksi (angka paling stabil agar tidak kena 'Invalid Range')
          aria2c -x10 -s10 -j10 -k1M --max-connection-per-server=10 \
          --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          --header="Referer: https://sourceforge.net/" \
          --connect-timeout=30 --timeout=30 --max-tries=20 \
          --retry-wait=2 --console-log-level=error --summary-interval=5 "$FINAL_URL"
          
          # Ambil nama file asli
          RAW_FILENAME=$(ls -p | grep -v / | head -n 1)
          
          # Bersihkan nama file
          CLEAN_FILENAME=$(echo "$RAW_FILENAME" | cut -d'!' -f1 | cut -d'?' -f1)
          
          if [ "$RAW_FILENAME" != "$CLEAN_FILENAME" ]; then
            mv "$RAW_FILENAME" "$CLEAN_FILENAME"
          fi
          
          # HITUNG HASH MD5
          FILE_MD5=$(md5sum "$CLEAN_FILENAME" | awk '{ print $1 }')
          echo "MD5_HASH=$FILE_MD5" >> $GITHUB_ENV
          
          echo "FILENAME=$CLEAN_FILENAME" >> $GITHUB_ENV
          echo "âœ… Berhasil download & bersihkan: $CLEAN_FILENAME"

      - name: Upload to GoFile
        run: |
          echo "ğŸš€ Memulai upload file: ${{ env.FILENAME }}"
          RESPONSE=$(curl -s -F "file=@${{ env.FILENAME }}" https://upload.gofile.io/uploadfile)
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.data.downloadPage // empty')
          
          if [[ -n "$DOWNLOAD_URL" && "$DOWNLOAD_URL" != "null" ]]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          else
            echo "âŒ Gagal upload ke GoFile. Respon: $RESPONSE"
            exit 1
          fi

      - name: Notify Telegram (Success)
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>âœ… Leech Berhasil!</b>%0A%0AğŸ“„ <b>File:</b> ${{ env.FILENAME }}%0AğŸ”‘ <b>MD5:</b> <code>${{ env.MD5_HASH }}</code>%0AğŸ”— <b>Link:</b> ${{ env.DOWNLOAD_URL }}"
