name: Syzo Leech Worker
on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=âš¡ *Worker Started!*%0A sedang men-download dari SourceForge...&parse_mode=Markdown"

     - name: Download File from SourceForge
        run: |
          sudo apt-get install -y aria2
          URL="${{ github.event.client_payload.url }}"
          
          # Download dengan wget dan biarkan wget menentukan nama file aslinya
          wget -U "Mozilla/5.0" --header="Referer: https://sourceforge.net/" --content-disposition "$URL"
          
          # Mengambil nama file yang baru saja didownload (file paling baru di folder)
          FILENAME=$(ls -t | head -n 1)
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV
          echo "âœ… Berhasil download: $FILENAME"

      - name: Upload to GoFile
        run: |
          echo "ğŸš€ Memulai upload file: ${{ env.FILENAME }}"
          
          # Upload menggunakan nama file asli
          RESPONSE=$(curl -s -F "file=@${{ env.FILENAME }}" https://upload.gofile.io/uploadfile)
          
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.data.downloadPage // empty')
          
          if [[ -n "$DOWNLOAD_URL" && "$DOWNLOAD_URL" != "null" ]]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          else
            echo "âŒ Gagal upload. Respon: $RESPONSE"
            exit 1
          fi

      - name: Upload to GoFile
        run: |
          echo "ğŸš€ Memulai upload anonim ke GoFile..."
          # Langsung filter link downloadPage agar variabelnya pendek dan bersih
          DOWNLOAD_URL=$(curl -s -F "file=@leech_file" https://upload.gofile.io/uploadfile | jq -r '.data.downloadPage // empty')
          
          # Gunakan tanda kutip untuk mencegah error "too many arguments"
          if [ -n "$DOWNLOAD_URL" ] && [ "$DOWNLOAD_URL" != "null" ]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
            echo "âœ… Berhasil mendapatkan link!"
          else
            echo "âŒ Gagal mendapatkan link download."
            exit 1
          fi

      - name: Notify Telegram (Success)
        if: success()
        run: |
          # Kirim notifikasi dengan link yang sudah sangat bersih
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>âœ… Leech Berhasil!</b>%0A%0AğŸ”— <b>Link Download:</b> ${{ env.DOWNLOAD_URL }}"
