name: Syzo Leech Worker
on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=âš¡ *Worker Started!*%0A Menganalisa jalur download terbaik...&parse_mode=Markdown"

      - name: Auto-Discovery & Download
        run: |
          sudo apt-get install -y aria2
          URL="${{ github.event.client_payload.url }}"
          
          # Daftar kandidat mirror kencang (Jepang, Irlandia, Jerman, Amerika)
          MIRRORS=("jaist.dl" "heanet.dl" "netcologne.dl" "pilotfiber.dl")
          BEST_URL="$URL" # Default ke link asli (Master)
          FOUND_FAST=false

          echo "ðŸ” Mengecek ketersediaan mirror kencang..."
          for MIRROR in "${MIRRORS[@]}"; do
            TEST_URL=$(echo "$URL" | sed "s/master.dl/$MIRROR/g")
            
            # Cek apakah mirror merespon dengan cepat (timeout 2 detik)
            if curl -I -s --connect-timeout 2 -L "$TEST_URL" | grep -q "200 OK"; then
              echo "âœ… Jalur kencang ditemukan: $MIRROR"
              BEST_URL="$TEST_URL"
              FOUND_FAST=true
              break
            fi
          done

          if [ "$FOUND_FAST" = true ]; then
            echo "ðŸš€ Memulai High-Speed Leech (Multi-Connection)..."
            # Pakai 16 koneksi karena mirror ini mendukung
            aria2c -x16 -s16 -k1M --max-connection-per-server=16 \
            --user-agent="Mozilla/5.0" --header="Referer: https://sourceforge.net/" \
            --console-log-level=error --summary-interval=5 "$BEST_URL"
          else
            echo "âš ï¸ Hanya tersedia Master Server. Memulai Stable Mode..."
            # Pakai 1 koneksi agar tidak kena 'Invalid range header' di server master
            aria2c -x1 -s1 -k1M --user-agent="Mozilla/5.0" \
            --header="Referer: https://sourceforge.net/" \
            --console-log-level=error --summary-interval=10 "$URL"
          fi

          # Ambil nama file asli & simpan ke ENV
          FILENAME=$(ls -p | grep -v / | head -n 1)
          CLEAN_NAME=$(echo "$FILENAME" | cut -d'!' -f1 | cut -d'?' -f1)
          [ "$FILENAME" != "$CLEAN_NAME" ] && mv "$FILENAME" "$CLEAN_NAME"
          
          echo "FILENAME=$CLEAN_NAME" >> $GITHUB_ENV
          echo "MD5_HASH=$(md5sum "$CLEAN_NAME" | awk '{print $1}')" >> $GITHUB_ENV

      - name: Upload to GoFile
        run: |
          RESPONSE=$(curl -s -F "file=@${{ env.FILENAME }}" https://upload.gofile.io/uploadfile)
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.data.downloadPage // empty')
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      - name: Notify Telegram (Success)
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>âœ… Leech Selesai!</b>%0A%0AðŸ“„ <b>File:</b> ${{ env.FILENAME }}%0AðŸ”‘ <b>MD5:</b> <code>${{ env.MD5_HASH }}</code>%0AðŸ”— <b>Link:</b> ${{ env.DOWNLOAD_URL }}"
