name: Syzo Leech Worker

on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ö° *Worker Started!*%0Asedang men-download dari SourceForge...&parse_mode=Markdown"

      - name: Install Dependencies
        run: sudo apt-get install -y aria2 jq

      - name: Download File from SourceForge
        run: |
          URL="${{ github.event.client_payload.url }}"
          aria2c -x 16 -s 16 --console-log-level=error "$URL"
          FILENAME=$(ls | grep -v "leech.yml" | head -n 1)
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Upload to GoFile
        id: upload
        run: |
          echo "üöÄ Uploading $FILENAME..."
          # Mengambil server terbaik secara otomatis
          SERVER=$(curl -s https://api.gofile.io/getServer | jq -r '.data.server')
          RESPONSE=$(curl -F "file=@$FILENAME" "https://$SERVER.gofile.io/uploadFile")
          
          DOWNLOAD_LINK=$(echo $RESPONSE | jq -r '.data.downloadPage')
          
          if [ "$DOWNLOAD_LINK" != "null" ]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_LINK" >> $GITHUB_ENV
            echo "‚úÖ Success: $DOWNLOAD_LINK"
          else
            echo "‚ùå Upload Failed"
            exit 1
          fi

      - name: Notify Telegram (Success)
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚úÖ *Leech Berhasil!*%0A%0Aüì¶ *File:* `${{ env.FILENAME }}`%0Aüîó *Link:* ${{ env.DOWNLOAD_URL }}&parse_mode=Markdown"

      - name: Notify Telegram (Failed)
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ùå *Leech Gagal!*%0APastikan link SourceForge benar atau server sedang tidak overload.&parse_mode=Markdown"
