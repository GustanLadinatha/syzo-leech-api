name: Syzo-Leech-Worker

on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 jq
          echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV

      - name: Universal High-Speed Download
        run: |
          URL="${{ github.event.client_payload.url }}"
          SELECTED_MIRROR="Direct/Original"
          
          if [[ "$URL" == *"sourceforge.net"* ]]; then
            PROJ_PATH=$(echo "$URL" | sed -n 's/.*projects\/\([^\/]*\).*/\1/p')
            FILE_PATH_SF=$(echo "$URL" | sed -e 's/.*files\///' -e 's/\/download.*//' -e 's/?.*//')
            
            if [ ! -z "$PROJ_PATH" ] && [ ! -z "$FILE_PATH_SF" ]; then
              MIRROR_LIST=$(curl -s -m 5 "https://sourceforge.net/settings/mirror_choices?projectname=${PROJ_PATH}&filename=${FILE_PATH_SF}" | grep -oP '(?<=id=").*?(?=")' | head -n 5 || echo "")
              if [ ! -z "$MIRROR_LIST" ]; then
                for m in $MIRROR_LIST; do
                  CLEAN_URL="https://downloads.sourceforge.net/project/${PROJ_PATH}/${FILE_PATH_SF}"
                  TEST_URL="${CLEAN_URL}?use_mirror=$m"
                  if curl -o /dev/null -sI -f -m 2 "$TEST_URL"; then
                    URL="$TEST_URL"
                    SELECTED_MIRROR="$m"
                    break
                  fi
                done
              fi
            fi
          fi
          echo "SELECTED_MIRROR=$SELECTED_MIRROR" >> $GITHUB_ENV

          # Gunakan koneksi yang lebih stabil (4 koneksi) untuk menghindari 'Invalid range header'
          aria2c --console-log-level=notice \
                 --summary-interval=1 \
                 --max-connection-per-server=4 \
                 --split=4 \
                 --min-split-size=1M \
                 --check-certificate=false \
                 --user-agent="Mozilla/5.0" \
                 "$URL" -d . > download_log.txt 2>&1 || true
          
          AVG_SPEED=$(tail -n 20 download_log.txt | grep "DL:" | tail -n 1 | grep -oP 'DL:\K.*?(?= )' || echo "N/A")
          echo "AVG_SPEED=$AVG_SPEED" >> $GITHUB_ENV

          # Mencari file hasil download yang asli (di atas 1MB)
          FINAL_FILE=$(find . -maxdepth 1 -type f -size +1M -not -path '*/.*' | head -n 1)
          if [ -z "$FINAL_FILE" ]; then
            FINAL_FILE=$(ls -t | grep -vE "index.py|vercel.json|yml|download_log.txt|requirements.txt" | head -n 1)
          fi
          
          if [ ! -z "$FINAL_FILE" ] && [ -f "$FINAL_FILE" ]; then
             echo "FILE_PATH=$FINAL_FILE" >> $GITHUB_ENV
             echo "FILENAME=$(basename "$FINAL_FILE")" >> $GITHUB_ENV
             echo "DOWNLOAD_STATUS=SUCCESS" >> $GITHUB_ENV
          else
             echo "DOWNLOAD_STATUS=FAILED" >> $GITHUB_ENV
          fi

      - name: Upload to Multi-Cloud (GoFile)
        if: env.DOWNLOAD_STATUS == 'SUCCESS'
        id: upload_step
        continue-on-error: true 
        run: |
          SERVER_RESP=$(curl -s https://api.gofile.io/servers)
          SERVER=$(echo $SERVER_RESP | jq -r '.data.servers[0].name // "store1"')
          RESPONSE=$(curl --connect-timeout 60 --retry 3 -s -F "file=@${{ env.FILE_PATH }}" "https://${SERVER}.gofile.io/contents/uploadfile")
          
          STATUS=$(echo $RESPONSE | jq -r '.status // "error"')
          if [[ "$STATUS" == "ok" ]]; then
            echo "FINAL_URL=$(echo $RESPONSE | jq -r '.data.downloadPage')" >> $GITHUB_ENV
            echo "UPLOAD_RESULT=SUCCESS" >> $GITHUB_ENV
          else
            echo "UPLOAD_RESULT=FAILED" >> $GITHUB_ENV
            echo "FINAL_URL=${{ github.event.client_payload.url }}" >> $GITHUB_ENV
          fi

      - name: Generate MD5 & Notify Vercel
        if: always()
        run: |
          if [ -f "${{ env.FILE_PATH }}" ]; then
            FILE_MD5=$(md5sum "${{ env.FILE_PATH }}" | awk '{print $1}')
          else
            FILE_MD5="N/A"
          fi
          
          URL_SEND="${{ env.FINAL_URL }}"
          [ -z "$URL_SEND" ] && URL_SEND="${{ github.event.client_payload.url }}"
          
          curl -s -X POST "https://syzo-leech-api.vercel.app/update_link" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"${{ github.run_id }}\", \"download_url\": \"$URL_SEND\", \"filename\": \"${{ env.FILENAME }}\", \"md5\": \"$FILE_MD5\"}"

      - name: Notify Telegram Result
        if: always()
        run: |
          if [[ "${{ job.status }}" == "cancelled" ]]; then
            MESSAGE="üõë *Leech Stopped*"
          elif [[ "${{ job.status }}" == "success" && "${{ env.UPLOAD_RESULT }}" == "SUCCESS" ]]; then
            MESSAGE="‚úÖ *Leech Completed*%0AüìÇ *File:* \`${{ env.FILENAME }}\` %0AüöÄ *Speed:* \`${{ env.AVG_SPEED }}\` %0Aüîó [Download Link](${{ env.FINAL_URL }})"
          else
            MESSAGE="‚ö†Ô∏è *Leech Completed (Fallback)*%0AüìÇ *File:* \`${{ env.FILENAME }}\` %0Aüîó [Original Link](${{ github.event.client_payload.url }})"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot8229203638:AAHI-0fu5NGv8kQmUm5ztd81gbOautvJBB4/sendMessage" \
          -d "chat_id=-5089072043&text=$MESSAGE&parse_mode=Markdown"
