name: Syzo-Leech-Worker

on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 jq
          echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV

      - name: Universal High-Speed Download
        run: |
          URL="${{ github.event.client_payload.url }}"
          
          if [[ "$URL" == *"sourceforge.net"* ]] && [[ "$URL" != *"use_mirror="* ]]; then
            echo "üîç SourceForge detected. Scraping all available mirrors..."
            
            # 1. Mendapatkan URL direct untuk melihat daftar mirror dari API
            # Kita mengambil project path dari URL asli
            PROJ_PATH=$(echo "$URL" | grep -oP '(?<=projects/).*?(?=/files/)' | head -1)
            FILE_PATH=$(echo "$URL" | grep -oP '(?<=files/).*?(?=/download|/|$)')
            
            if [ ! -z "$PROJ_PATH" ]; then
              echo "üì° Fetching mirror list for: $FILE_PATH"
              # Ambil daftar mirror resmi dari API SourceForge
              MIRROR_LIST=$(curl -s "https://sourceforge.net/settings/mirror_choices?projectname=${PROJ_PATH}&filename=${FILE_PATH}" | grep -oP '(?<=id=").*?(?=")' | head -n 8)
              
              for m in $MIRROR_LIST; do
                # Bersihkan URL dari parameter ?viasf
                CLEAN_URL=$(echo "$URL" | sed 's/\?viasf=.*//' | sed 's/\?use_mirror=.*//')
                TEST_URL="${CLEAN_URL}?use_mirror=$m"
                
                echo -n "‚ö° Testing mirror [$m]... "
                # Cek respon tercepat dalam 1.5 detik
                if curl -o /dev/null -sI -f -m 1.5 "$TEST_URL"; then
                  URL="$TEST_URL"
                  echo "üî• SELECTED (Fastest Response)"
                  break
                else
                  echo "‚ùå SKIP"
                fi
              done
            fi
          fi

          echo "üöÄ Final Turbo URL: $URL"
          
          # Jalankan Aria2 dengan 16 koneksi (Maksimal untuk GitHub)
          aria2c --console-log-level=warn \
                 --summary-interval=1 \
                 --max-connection-per-server=16 \
                 --split=16 \
                 --min-split-size=1M \
                 --buffer-size=2M \
                 --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
                 "$URL" -d .

      - name: Upload to Multi-Cloud (GoFile)
        id: upload_step
        continue-on-error: true 
        run: |
          echo "üöÄ Getting Best GoFile Server..."
          # Fix: Gunakan --silent dan filter jq yang lebih aman
          SERVER_RESP=$(curl -s https://api.gofile.io/servers)
          SERVER=$(echo $SERVER_RESP | jq -r '.data.servers[0].name // "store1"')
          
          echo "üöÄ Uploading to GoFile ($SERVER)..."
          # Tambahkan retry otomatis jika koneksi terputus
          RESPONSE=$(curl --retry 3 -s -F "file=@${{ env.FILE_PATH }}" "https://${SERVER}.gofile.io/contents/uploadfile")
          
          STATUS=$(echo $RESPONSE | jq -r '.status // "error"')
          if [[ "$STATUS" == "ok" ]]; then
            DOWNLOAD_URL=$(echo $RESPONSE | jq -r '.data.downloadPage')
            echo "FINAL_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
            echo "UPLOAD_RESULT=SUCCESS" >> $GITHUB_ENV
          else
            echo "‚ùå Upload Failed, using Fallback"
            echo "FINAL_URL=${{ github.event.client_payload.url }}" >> $GITHUB_ENV
            echo "UPLOAD_RESULT=FALLBACK" >> $GITHUB_ENV
          fi

      - name: Generate MD5 & Notify Vercel
        if: always()
        run: |
          # --- PROSES GENERATE MD5 ---
          FILE_MD5=$(md5sum "${{ env.FILE_PATH }}" | awk '{print $1}')
          echo "FILE_MD5=$FILE_MD5" >> $GITHUB_ENV
          
          URL_TO_SEND="${{ env.FINAL_URL }}"
          if [[ -z "$URL_TO_SEND" ]]; then URL_TO_SEND="${{ github.event.client_payload.url }}"; fi
          
          echo "üì° Sending data to Vercel..."
          curl -s -X POST "https://syzo-leech-api.vercel.app/update_link" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"${{ github.run_id }}\", \"download_url\": \"$URL_TO_SEND\", \"filename\": \"${{ env.FILENAME }}\", \"md5\": \"$FILE_MD5\"}"

      - name: Notify Telegram Result
        if: always()
        run: |
          # Penentuan status akhir untuk pesan Telegram
          if [[ "${{ job.status }}" == "success" ]]; then
            if [[ "${{ env.UPLOAD_RESULT }}" == "SUCCESS" ]]; then
              STATUS_EMOJI="‚úÖ"
              STATUS_TEXT="Leech Completed"
              LINK_TYPE="Cloud: GoFile"
            else
              STATUS_EMOJI="‚ö†Ô∏è"
              STATUS_TEXT="Leech Completed (Fallback)"
              LINK_TYPE="Source: Original Link"
            fi
            
            MESSAGE="${STATUS_EMOJI} *${STATUS_TEXT}*%0AüìÇ *File:* \`${{ env.FILENAME }}\` %0Aüì¶ *Storage:* ${LINK_TYPE}%0Aüîë *MD5:* \`${{ env.FILE_MD5 }}\` %0Aüîó [Download Link](${{ env.FINAL_URL }})"
          
          elif [[ "${{ job.status }}" == "cancelled" ]]; then
            MESSAGE="üõë *Leech Stopped*%0A‚ö†Ô∏è Proses dihentikan oleh pengguna dari website."
          else
            MESSAGE="‚ùå *Leech Failed*%0A‚ö†Ô∏è Terjadi error saat proses download/upload."
          fi
          
          curl -s -X POST "https://api.telegram.org/bot8229203638:AAHI-0fu5NGv8kQmUm5ztd81gbOautvJBB4/sendMessage" \
          -d "chat_id=-5089072043&text=$MESSAGE&parse_mode=Markdown"
