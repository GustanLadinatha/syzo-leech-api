name: Syzo Leech Worker

on:
  repository_dispatch:
    types: [start-leech]

jobs:
  leech-job:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (Process Start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ö° *Worker Started!*%0Asedang mem-download file...&parse_mode=Markdown"

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y aria2 jq wget

      - name: Download File
        run: |
          URL="${{ github.event.client_payload.url }}"
          wget -q --show-progress --content-disposition "$URL"
          
          # Bersihkan nama file dari karakter aneh URL
          RAW_NAME=$(ls -p | grep -v / | grep -v "leech.yml" | head -n 1)
          CLEAN_NAME=$(echo "$RAW_NAME" | cut -d'?' -f1)
          
          if [ "$RAW_NAME" != "$CLEAN_NAME" ]; then
            mv "$RAW_NAME" "$CLEAN_NAME"
          fi
          echo "FILENAME=$CLEAN_NAME" >> $GITHUB_ENV

      - name: Upload to GoFile
        id: upload
        run: |
          echo "üöÄ Uploading ${{ env.FILENAME }}..."
          
          # 1. Ambil server yang tersedia
          SERVER_DATA=$(curl -s https://api.gofile.io/getServer)
          SERVER=$(echo $SERVER_DATA | jq -r '.data.server // "store1"')
          
          # 2. Upload file
          RESPONSE=$(curl -F "file=@${{ env.FILENAME }}" "https://${SERVER}.gofile.io/uploadFile")
          echo "Server Response: $RESPONSE"
          
          # 3. Ambil link dengan pengecekan extra
          DOWNLOAD_LINK=$(echo $RESPONSE | jq -r '.data.downloadPage // empty')
          
          if [[ -n "$DOWNLOAD_LINK" && "$DOWNLOAD_LINK" != "null" ]]; then
            echo "DOWNLOAD_URL=$DOWNLOAD_LINK" >> $GITHUB_ENV
            echo "‚úÖ Upload Berhasil"
          else
            echo "‚ùå Upload Gagal. Server Response: $RESPONSE"
            exit 1
          fi

      - name: Notify Telegram (Success)
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚úÖ *Leech Berhasil!*%0A%0Aüì¶ *File:* `${{ env.FILENAME }}`%0Aüîó *Link:* ${{ env.DOWNLOAD_URL }}&parse_mode=Markdown"

      - name: Notify Telegram (Failed)
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN_BOT }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}&text=‚ùå *Leech Gagal!*%0AProses terhenti di server. Coba lagi dalam beberapa saat.&parse_mode=Markdown"
